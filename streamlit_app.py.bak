import os
import asyncio
import base64
from io import BytesIO
from typing import List, Dict, Any

import streamlit as st
from dotenv import load_dotenv

from app.azure_tools import tool_router as http_tool_router, TOOLS_SPEC as _  # noqa: F401


load_dotenv()
st.set_page_config(page_title="Kids English Agent", page_icon="?ˆ", layout="wide")
st.title("Kids English Agent")


def use_functions_tools() -> bool:
    return os.getenv("USE_FUNCTION_TOOLS", "false").lower() in ("1", "true", "yes")


async def call_tool(name: str, args: Dict[str, Any]):
    if use_functions_tools():
        try:
            return await http_tool_router(name, args)
        except Exception:
            pass
    # Local stubs
    if name == "search_youtube_videos":
        chs = args.get("characters") or ["ë¸”ë£¨??]
        vids = [
            "dQw4w9WgXcQ",
            "J---aiyznGQ",
            "9bZkp7q19f0",
            "kJQP7kiw5Fk",
            "3JZ_D3ELwOQ",
        ]
        out = []
        for i, vid in enumerate(vids):
            out.append({
                "id": vid,
                "title": f"{chs[0]} learns colors #{i+1}",
                "channel": "Kids Channel",
                "url": f"https://www.youtube.com/watch?v={vid}",
                "durationSec": 180 + i * 15,
                "hasCaptions": True,
                "thumbnail": f"https://img.youtube.com/vi/{vid}/hqdefault.jpg",
                "tags": [args.get("cefr", "A1"), chs[0]],
            })
        maxn = max(1, min(int(args.get("max", 5)), len(out)))
        return out[:maxn]
    if name == "index_video":
        return {"transcriptId": "tx_local_1", "lang": "en", "wordCounts": {}, "segments": []}
    if name == "extract_top_words":
        return [
            {"word": "forest", "pos": "noun", "cefr": "A1", "definition": "a large area of trees"},
            {"word": "climb", "pos": "verb", "cefr": "A1", "definition": "go up something"},
            {"word": "brave", "pos": "adj", "cefr": "A2", "definition": "showing no fear"},
        ][: args.get("count", 5)]
    if name == "extract_top_expressions":
        c = int(args.get("count", 3))
        phrases = ["Let's go!", "Good job!", "Come on!"]
        return {"phrases": phrases[:c]}
    if name == "example_sentence":
        return {"sentence": f"The {args.get('word','word')} is fun to say."}
    if name == "update_progress":
        return {"ok": True, "newLevel": "A1", "streak": 1}
    if name == "parent_report":
        return {
            "summaryText": "?´ë²ˆ ì£??˜í–ˆ?´ìš”! 4???™ìŠµ, 15?¨ì–´.",
            "kpis": {"watchMin": 120, "sessions": 4, "wordsLearned": 15, "levelChange": "+1"},
            "chartData": {"series": [{"name": "Sessions", "data": [1, 2, 1, 0, 0, 0, 0]}]},
        }
    if name == "find_local_academies":
        return [
            {"name": "?´í”¼ ?‰ê?ë¦¬ì‹œ", "phone": "010-1234-5678", "address": args.get("address", ""), "mapUrl": None, "distanceM": 850}
        ]
    if name == "search_academies_ai":
        return [
            {"name": "Kids English Academy", "address": args.get("region", ""), "phone": "02-000-0000", "mapUrl": None},
            {"name": "Happy Language School", "address": args.get("region", ""), "phone": "02-111-2222", "mapUrl": None},
        ][: args.get("topK", 5)]
    if name == "say_word":
        return {"audioB64": None, "audioUrl": None}
    if name == "play_cheer":
        return {"audioUrl": None}
    return {"error": f"unknown tool {name}"}


def derive_cefr(age: int, study: str) -> str:
    if age <= 5:
        return "PREA1"
    if age <= 7:
        return "A1"
    return "A2" if study and study != "?†ë‹¤" else "A1"


# Session state
if "profile" not in st.session_state:
    st.session_state["profile"] = None
if "selected_video" not in st.session_state:
    st.session_state["selected_video"] = None
if "learning_cards" not in st.session_state:
    st.session_state["learning_cards"] = []
if "watched_ids" not in st.session_state:
    st.session_state["watched_ids"] = set()
if "watch_history" not in st.session_state:
    st.session_state["watch_history"] = []  # {videoId,title,watched,learned}
    # Try loading existing profile from backend on first run
    try:
        resp = asyncio.run(call_tool("load_profile", {"childId": "local_child"}))
        if isinstance(resp, dict) and resp.get("ok") and resp.get("profile") and not st.session_state.get("profile"):
            prof = resp.get("profile") or {}
            prof["childId"] = prof.get("childId") or "local_child"
            st.session_state["profile"] = prof
    except Exception:
        pass


def setup_view():
    st.subheader("ì´ˆê¸° ?¤ì •")
    with st.form("setup_form", clear_on_submit=False):
        age = st.number_input("?˜ì´(ë§?", min_value=1, max_value=15, value=7)
        region = st.text_input("ì§€??, value="?œìš¸ ?€?‰êµ¬ ?‘ì•”??, placeholder="?? ?œìš¸ ?€?‰êµ¬ ?‘ì•”??)
        study = st.selectbox("?ì–´ ê³µë? ê¸°ê°„", ["?†ë‹¤", "1~3ê°œì›”", "3~6ê°œì›”", "6ê°œì›” ?´ìƒ"], index=0)
        characters = st.multiselect("ì¢‹ì•„?˜ëŠ” ìºë¦­??, ["ë¸”ë£¨??, "ë½€ë¡œë¡œ", "?˜íŒŒ ?¼ê·¸", "?¬ì¼“ëª?, "?‘í¬??], default=["ë¸”ë£¨??]) 
        other = st.text_input("ê¸°í? ìºë¦­???¼í‘œë¡?êµ¬ë¶„)", placeholder="?? ?˜íŒŒ ?¼ê·¸, ?¼ì¹´ì¸?)
        child_id = st.text_input("ID", value="local_child")
        col_s1, col_s2 = st.columns(2)
        save_clicked = col_s1.form_submit_button("?¤ì • ?€??)
        save_and_go_clicked = col_s2.form_submit_button("?€?????„ë™ ?”ë©´ ?´ë™")

    # ????ë°–ì—??ì²˜ë¦¬
    if save_clicked or save_and_go_clicked:
        chars = list(characters) if characters else []
        if other.strip():
            chars.extend([c.strip() for c in other.split(",") if c.strip()])
        cefr = derive_cefr(int(age), study)
        st.session_state.update({
            "profile": {
                "age": int(age),
                "region": region.strip(),
                "study": study,
                "characters": chars or ["ë¸”ë£¨??],
                "cefr": cefr,
                "childId": (child_id.strip() or "local_child"),
            },
            "setup_saved": True,
            "goto_child": bool(save_and_go_clicked),
        })
        try:
            _ = asyncio.run(call_tool("save_profile", {
                "childId": st.session_state["profile"]["childId"],
                "name": st.session_state["profile"].get("name", ""),
                "age": st.session_state["profile"]["age"],
                "region": st.session_state["profile"]["region"],
                "study": st.session_state["profile"]["study"],
                "characters": st.session_state["profile"]["characters"],
                "cefr": st.session_state["profile"]["cefr"],
                "interest": st.session_state["profile"].get("interest", 4),
            }))
        except Exception:
            pass
        st.success("?¤ì •???€?¥ë˜?ˆìŠµ?ˆë‹¤.")
        if save_and_go_clicked:
            st.rerun()


def child_view():
    prof = st.session_state["profile"]
    st.subheader("?„ë™?????ìƒ ?œì²­ ë°??™ìŠµ")
    col_left, col_right = st.columns([3, 2], gap="large")

    # Get 2 recommendations and filter out watched
    results: List[Dict[str, Any]] = []
    try:
        results = asyncio.run(call_tool("search_youtube_videos", {
            "age": prof["age"], "cefr": prof["cefr"], "characters": prof["characters"], "max": 2
        }))
    except Exception as e:
        st.warning(f"ì¶”ì²œ ê²€???¤íŒ¨: {e}")
    watched_ids = set(st.session_state.get("watched_ids", set()))
    results = [it for it in (results or []) if it.get("id") not in watched_ids]

    with col_left:
        sel = st.session_state.get("selected_video")
        st.markdown("#### ?œì²­ ?”ë©´")
        if sel:
            st.write(sel["title"])
            st.video(sel["url"])
            if st.button("?œì²­ ?„ë£Œ", key="btn_watch_done"):
                vid_id = sel.get("id", ""); title = sel.get("title", "")
                st.session_state["watched_ids"].add(vid_id)
                # ê¸°ë¡ ?…ë°?´íŠ¸
                found = False
                for it in st.session_state["watch_history"]:
                    if it.get("videoId") == vid_id:
                        it["watched"] = True; found = True; break
                if not found:
                    st.session_state["watch_history"].append({"videoId": vid_id, "title": title, "watched": True, "learned": False})
                # ë°”ë¡œ ?™ìŠµ ì¹´ë“œ ?ì„± (?ìœ„ 5 ?¨ì–´)
                try:
                    idx = asyncio.run(call_tool("index_video", {"videoUrl": sel["url"]}))
                    tx_id = idx.get("transcriptId", "tx")
                    words = asyncio.run(call_tool("extract_top_words", {"transcriptId": tx_id, "count": 5, "cefr": prof["cefr"]}))
                    cards = []
                    for w in words:
                        ex = asyncio.run(call_tool(
                            "example_sentence",
                            {"word": w.get("word",""), "cefr": prof["cefr"], "context": {"videoTitle": sel.get("title",""), "character": (prof.get("characters") or [""])[0]}}
                        ))
                        cards.append({
                            "word": w.get("word",""),
                            "definition": w.get("definition", ""),
                            "sentence": ex.get("sentence", ""),
                            "imageUrl": f"https://source.unsplash.com/400x240/?{w.get('word','')},kids",
                        })
                    st.session_state["learning_cards"] = cards
                    st.success("?œì²­ ?„ë£Œ! ?´ë‹¹ ?ìƒ???™ìŠµ ì¹´ë“œ 5ê°œë? ì¤€ë¹„í–ˆ?´ìš”.")
                except Exception as e:
                    st.error(f"?™ìŠµ ì¹´ë“œ ?ì„± ?¤íŒ¨: {e}")
            if st.button("?™ìŠµ ?œì‘", key="start_learning_btn"):
                try:
                    idx = asyncio.run(call_tool("index_video", {"videoUrl": sel["url"]}))
                    tx_id = idx.get("transcriptId", "tx")
                    words = asyncio.run(call_tool("extract_top_words", {"transcriptId": tx_id, "count": 5, "cefr": prof["cefr"]}))
                    cards = []
                    for w in words:
                        ex = asyncio.run(call_tool("example_sentence", {"word": w["word"], "cefr": prof["cefr"], "context": {"videoTitle": sel["title"], "character": (prof["characters"] or [""])[0]}}))
                        cards.append({"word": w["word"], "definition": w.get("definition", ""), "sentence": ex.get("sentence", ""), "imageUrl": f"https://source.unsplash.com/400x240/?{w['word']},kids"})
                    st.session_state["learning_cards"] = cards
                    st.success("?™ìŠµ ì¹´ë“œê°€ ì¤€ë¹„ë˜?ˆìŠµ?ˆë‹¤.")
                except Exception as e:
                    st.error(f"?™ìŠµ ì¹´ë“œ ?ì„± ?¤íŒ¨: {e}")
        else:
            st.info("?„ë˜ ì¶”ì²œ ëª©ë¡?ì„œ ?ìƒ??? íƒ?˜ì„¸??")

        st.markdown("#### ì¶”ì²œ ?ìƒ")
        if results:
            cols = st.columns(2)
            for i, item in enumerate(results):
                with cols[i % 2]:
                    if item.get("thumbnail"):
                        st.image(item["thumbnail"], width='stretch')
                    st.caption(item.get("channel", ""))
                    st.write(f"**{item['title']}**")
                    if st.button("?œì²­", key=f"watch_{i}"):
                        st.session_state["selected_video"] = item
                        st.session_state["learning_cards"] = []
                        st.rerun()
        else:
            st.write("?ˆë¡œ??ì¶”ì²œ???†ìŠµ?ˆë‹¤. ? ì‹œ ???¤ì‹œ ?œë„??ì£¼ì„¸??")

    with col_right:
        st.markdown("#### ?™ìŠµ ?”ë©´")
        cards: List[Dict[str, Any]] = st.session_state.get("learning_cards", [])
        if cards:
            st.markdown("?™ìŠµ ì¹´ë“œ (5)")
            for idx, c in enumerate(cards):
                st.markdown(f"**{idx+1}. {c['word']}** ??{c['definition']}")
                cc1, cc2 = st.columns([2, 1])
                with cc1:
                    if c.get("imageUrl"):
                        st.image(c["imageUrl"], width='stretch')
                with cc2:
                    st.caption("?ˆë¬¸")
                    st.write(c.get("sentence", ""))
                    if st.button("ë°œìŒ ?£ê¸°", key=f"say_{idx}"):
                        try:
                            resp = asyncio.run(call_tool("say_word", {"word": c["word"], "voice": "en-US-AvaNeural"}))
                            b64 = resp.get("audioB64")
                            if b64:
                                st.audio(BytesIO(base64.b64decode(b64)), format="audio/mp3")
                            elif resp.get("audioUrl"):
                                st.audio(resp["audioUrl"])  # fallback
                        except Exception as e:
                            st.warning(f"ë°œìŒ ?ì„± ?¤íŒ¨: {e}")
            if st.button("?„ë£Œ(ì§„í–‰???€??", key="save_progress_btn"):
                try:
                    sel = st.session_state.get("selected_video") or {}
                    _ = asyncio.run(call_tool("update_progress", {
                        "childId": prof["childId"],
                        "videoId": sel.get("id", ""),
                        "learnedWords": [c["word"] for c in cards],
                        "quizScore": 90,
                        "durationSec": sel.get("durationSec", 300),
                    }))
                    # mark learned
                    vid_id = sel.get("id", ""); title = sel.get("title", "")
                    found = False
                    for it in st.session_state["watch_history"]:
                        if it.get("videoId") == vid_id:
                            it["learned"] = True; found = True; break
                    if not found:
                        st.session_state["watch_history"].append({"videoId": vid_id, "title": title, "watched": False, "learned": True})
                    # cheer
                    try:
                        cheer = asyncio.run(call_tool("play_cheer", {"voice": "child", "style": "cheerful"}))
                        if cheer.get("audioUrl"):
                            st.audio(cheer["audioUrl"]) 
                    except Exception:
                        pass
                    st.success("?„ë£Œ! ?˜í–ˆ?´ìš” ?‰")
                except Exception as e:
                    st.error(f"?€???¤íŒ¨: {e}")
        else:
            st.write("?ìƒ?ì„œ ?˜í•™???œì‘?™ì„ ?„ë¥´ë©?ì¶”ì²œ ?¨ì–´ê°€ ?¬ê¸°???˜í??©ë‹ˆ??")


def parent_view():
    prof = st.session_state["profile"]
    st.subheader("ë¶€ëª¨ìš© ??ì§„í–‰ ì²´í¬ ë°??™ì› ì°¾ê¸°")
    col1, col2 = st.columns(2)
    with col1:
        st.markdown("#### ?™ìŠµ ?”ì•½ (7??")
        try:
            rep = asyncio.run(call_tool("parent_report", {"childId": prof["childId"], "period": "7d"}))
            st.write(rep.get("summaryText", ""))
            k = rep.get("kpis", {})
            st.metric("?œì²­ ë¶?, k.get("watchMin", 0))
            st.metric("?¸ì…˜", k.get("sessions", 0))
            st.metric("?™ìŠµ ?¨ì–´", k.get("wordsLearned", 0))
            st.metric("?ˆë²¨ ë³€??, k.get("levelChange", "+0"))
        except Exception as e:
            st.warning(f"?”ì•½ ì¡°íšŒ ?¤íŒ¨: {e}")

        # Local summary
        hist = st.session_state.get("watch_history", [])
        watched_cnt = sum(1 for h in hist if h.get("watched"))
        learned_cnt = sum(1 for h in hist if h.get("learned"))
        st.markdown("#### ë¡œì»¬ ?”ì•½")
        st.metric("?œì²­ ?„ë£Œ ?ìƒ ??, watched_cnt)
        st.metric("?™ìŠµ ì¹´ë“œ ?„ë£Œ ??, learned_cnt)
        if hist:
            st.caption("ìµœê·¼ ?œë™")
            for h in hist[-5:][::-1]:
                st.write(f"- {h.get('title','(?œëª©?†ìŒ)')} ???œì²­:{'O' if h.get('watched') else 'X'} / ?™ìŠµ:{'O' if h.get('learned') else 'X'}")

    with col2:
        st.markdown("#### ?„ë¡œ???¤ì •")
        study_opts = ["?†ë‹¤", "1~3ê°œì›”", "3~6ê°œì›”", "6ê°œì›” ?´ìƒ"]
        idx = study_opts.index(prof.get("study", "?†ë‹¤")) if prof.get("study", "?†ë‹¤") in study_opts else 0
        with st.form("edit_profile_form"):
            age = st.number_input("?˜ì´(ë§?", min_value=1, max_value=15, value=int(prof.get("age", 7)))
            region = st.text_input("ì§€??, value=prof.get("region", ""), placeholder="?? ?œìš¸ ?€?‰êµ¬ ?‘ì•”??)
            study = st.selectbox("?ì–´ ê³µë? ê¸°ê°„", study_opts, index=idx)
            saved = st.form_submit_button("ë³€ê²??¬í•­ ?€??)
            if saved:
                new_cefr = derive_cefr(int(age), study)
                prof.update({"age": int(age), "region": region.strip(), "study": study, "cefr": new_cefr})
                st.success(f"?€???„ë£Œ (CEFR: {new_cefr})")
                try:
                    _ = asyncio.run(call_tool("save_profile", {
                        "childId": prof.get("childId", "local_child"),
                        "name": name.strip(),
                        "age": int(age),
                        "region": region.strip(),
                        "study": study,
                        "characters": list(dict.fromkeys(all_chars)),
                        "cefr": new_cefr,
                        "interest": int(interest),
                    }))
                except Exception:
                    pass
                st.session_state["selected_video"] = None
                st.session_state["learning_cards"] = []
                st.rerun()

        # ì£¼ë? ?ì–´ ?™ì› ì¶”ì²œ (?¥ë????’ì„ ???¸ì¶œ)
        try:
            interest_val = int(prof.get("interest", 4))
        except Exception:
            interest_val = 4
        if (interest_val >= 4) and prof.get("region"):
            st.markdown("#### ì£¼ë? ?ì–´ ?™ì› ì¶”ì²œ")
            if st.button("?™ì› ì¶”ì²œ ë³´ê¸°", key="btn_search_academies_ai"):
                try:
                    res = asyncio.run(call_tool("search_academies_ai", {"region": prof.get("region", ""), "query": "english academy kids", "topK": 5}))
                    if isinstance(res, list) and res:
                        for a in res:
                            name = a.get('name','?™ì›'); addr = a.get('address',''); phone = a.get('phone')
                            st.write(f"- {name} / {addr}{' / ' + phone if phone else ''}")
                            if a.get('mapUrl'):
                                st.caption(a.get('mapUrl'))
                    else:
                        st.info("ì¶”ì²œ ê²°ê³¼ê°€ ë¶€ì¡±í•´?? ì§€??ª…????êµ¬ì²´?ìœ¼ë¡??…ë ¥??ë³´ì„¸??")
                except Exception as e:
                    st.error(f"?™ì› ì¶”ì²œ ?¤íŒ¨: {e}")

        st.markdown("#### ?¥ë???ì²´í¬")
        interest = st.slider("?„ë™???¥ë???, 1, 5, 4)
        st.caption("?’ì„?˜ë¡ ???´ë ¤???ìƒ??ì¶”ì²œ?©ë‹ˆ??")
        if st.button("?˜ì? ?¬ì¡°???œì•ˆ"):
            st.success("?¤ìŒ ì¶”ì²œ?ì„œ ???¨ê³„ ?’ì? ?ìƒ???œë„??ë³¼ê²Œ??")

    st.markdown("---")
    st.markdown("#### ?°ë¦¬ ?™ë„¤ ?™ì› ì°¾ê¸°")
    radius = st.select_slider("ë°˜ê²½(ë¯¸í„°)", options=[1000, 2000, 3000, 5000], value=3000)
    if st.button("?™ì› ê²€??):
        try:
            results = asyncio.run(call_tool("find_local_academies", {"address": prof["region"], "radiusMeters": int(radius), "tags": ["english", "kids"], "topK": 5}))
            for a in results:
                st.write(f"- {a['name']} ({a.get('distanceM','?')}m) ??{a['address']} ??{a.get('phone','')}")
        except Exception as e:
            st.error(f"?™ì› ê²€???¤íŒ¨: {e}")


# New helper: suggest characters by age buckets
def suggest_characters_by_age(age: int) -> list[str]:
    if age <= 3:
        return [
            "Cocomelon",
            "Super Simple Songs",
            "Baby Einstein",
            "Hey Duggee",
            "Pocoyo",
            "Shaun the Sheep",
        ]
    if age <= 6:
        return [
            "Peppa Pig",
            "Bluey",
            "Ben & Holly's Little Kingdom",
            "Thomas & Friends",
            "Octonauts",
            "Alphablocks",
            "Numberblocks",
        ]
    if age <= 9:
        return [
            "Wild Kratts",
            "The Magic School Bus",
            "Odd Squad",
            "Hilda",
            "Carmen Sandiego",
        ]
    return ["Crash Course Kids", "TED-Ed", "BBC Newsround"]


# New setup view v2 per spec
def setup_view_v2_old():
    st.subheader("ì´ˆê¸° ?¤ì •")
    with st.form("setup_form_v2"):
        age = st.number_input("?˜ì´(ë§?", min_value=0, max_value=10, value=6)
        region = st.text_input("ì§€??, value="?œìš¸ ë§ˆí¬êµ??©ì •??, placeholder="?? ?œìš¸ ë§ˆí¬êµ??©ì •??)
        study = st.selectbox("?ì–´ ê³µë? ê¸°ê°„", ["ì²˜ìŒ?´ë‹¤", "1~3ê°œì›”", "3~6ê°œì›”", "6ê°œì›” ?´ìƒ"], index=0)
        name = st.text_input("?´ë¦„", value="")
        child_id = st.text_input("ID", value="local_child")
        name = st.text_input("?´ë¦„", value="")
        suggested = suggest_characters_by_age(int(age))
        base_options = list(dict.fromkeys(suggested + [
            "Pororo", "Peppa Pig", "Bluey", "Pikachu", "Pinkfong",
            "Ben & Holly's Little Kingdom", "Thomas & Friends", "Octonauts",
            "Alphablocks", "Numberblocks", "Cocomelon", "Super Simple Songs",
            "Pocoyo", "Shaun the Sheep",
        ]))
        characters = st.multiselect("ì¢‹ì•„?˜ëŠ” ìºë¦­??, options=base_options, default=suggested)
        other = st.text_input("ê¸°í? ìºë¦­???¼í‘œë¡?êµ¬ë¶„)", placeholder="?? Pororo, Pikachu")
        save_clicked = st.form_submit_button("?¤ì • ?€??)
        if save_clicked:
            chars = list(characters)
            if other.strip():
                chars.extend([c.strip() for c in other.split(",") if c.strip()])
            cefr = derive_cefr(int(age), study)
            st.session_state["profile"] = {
                "age": int(age),
                "region": region.strip(),
                "study": study,
                "characters": chars or suggested,
                "cefr": cefr,
                "childId": "local_child",
                "interest": 4,
                "name": name.strip() or "",
            }
            st.success("?¤ì •???€?¥í–ˆ?´ìš”. ?•ì¸???„ë¥´ë©???œ¼ë¡??´ë™?©ë‹ˆ??")
            if st.button("?•ì¸", key="confirm_setup_go_tabs"):
                # ë°”ë¡œ ???”ë©´?¼ë¡œ ?„í™˜ (?„ë¡œ?„ì´ ?¤ì •?˜ì—ˆ?¼ë?ë¡??¤ìŒ ?Œë”?ì„œ ???¸ì¶œ)
                st.rerun()
    # ?•ì¸ ë²„íŠ¼(??ë°”ê¹¥)
    if st.session_state.get("setup_saved"):
        if st.button("?•ì¸", key="confirm_setup_go_tabs"):
            st.session_state["setup_saved"] = False
            st.rerun()

# New child view v2 per spec
def child_view_v2():
    prof = st.session_state["profile"]
    st.subheader("?„ë™??ì¶”ì²œ ë°??™ìŠµ")
    col_left, col_right = st.columns([3, 2], gap="large")

    results: list[dict[str, Any]] = []
    try:
        fetched = asyncio.run(call_tool("search_youtube_videos", {
            "age": prof["age"], "cefr": prof["cefr"], "characters": prof.get("characters", []), "max": 8
        })) or []
        watched_ids = set(st.session_state.get("watched_ids", set()))
        results = [it for it in fetched if it.get("id") not in watched_ids][:2]
    except Exception as e:
        st.warning(f"ì¶”ì²œ ?¤íŒ¨: {e}")

    hist = st.session_state.get("watch_history", [])
    recent_watched = [h for h in hist if h.get("watched")][-2:][::-1]
    if recent_watched:
        st.markdown("##### ìµœê·¼ ?œì²­ ?„ë£Œ")
        cols = st.columns(len(recent_watched))
        for i, h in enumerate(recent_watched):
            with cols[i]:
                st.write(h.get("title", "(?œëª© ?†ìŒ)"))
                if st.button("?¤ì‹œ ë³´ê¸°", key=f"rewatch_{i}"):
                    vid = h.get("videoId", "")
                    st.session_state["selected_video"] = {
                        "id": vid,
                        "title": h.get("title", ""),
                        "url": f"https://www.youtube.com/watch?v={vid}",
                        "durationSec": 300,
                        "hasCaptions": True,
                    }
                    st.session_state["learning_cards"] = []
                    st.rerun()

    with col_left:
        sel = st.session_state.get("selected_video")
        st.markdown("#### ?œì²­ ?”ë©´")
        if sel:
            st.write(sel.get("title", ""))
            st.video(sel.get("url", ""))
            if st.button("?œì²­ ?„ë£Œ", key="btn_watch_done_v2"):
                vid_id = sel.get("id", "")
                title = sel.get("title", "")
                st.session_state.setdefault("watched_ids", set()).add(vid_id)
                found = False
                for it in st.session_state["watch_history"]:
                    if it.get("videoId") == vid_id:
                        it["watched"] = True
                        found = True
                        break
                if not found:
                    st.session_state["watch_history"].append({"videoId": vid_id, "title": title, "watched": True, "learned": False})
                try:
                    idx = asyncio.run(call_tool("index_video", {"videoUrl": sel.get("url", "")}))
                    tx_id = idx.get("transcriptId", "tx")
                    exps = asyncio.run(call_tool("extract_top_expressions", {"transcriptId": tx_id, "count": 3, "cefr": prof.get("cefr")}))
                    phrases = exps.get("phrases") if isinstance(exps, dict) else exps
                    cards = [{"phrase": p, "imageUrl": f"https://source.unsplash.com/400x240/?kids"} for p in (phrases or [])]
                    st.session_state["learning_cards"] = cards
                    st.success("?œì²­ ?„ë£Œ! ?ì£¼ ?˜ì˜¨ ?œí˜„ 3ê°€ì§€ë¥?ì¤€ë¹„í–ˆ?´ìš”.")
                except Exception as e:
                    st.error(f"?™ìŠµ ì¹´ë“œ ?ì„± ?¤íŒ¨: {e}")
                st.rerun()
        else:
            st.info("?„ë˜ ì¶”ì²œ ëª©ë¡?ì„œ ?ìƒ??? íƒ?˜ì„¸??)

        st.markdown("#### ì¶”ì²œ ?ìƒ (2)")
        if results:
            cols = st.columns(2)
            for i, item in enumerate(results):
                with cols[i % 2]:
                    if item.get("thumbnail"):
                        st.image(item["thumbnail"], use_container_width=True)
                    st.caption(item.get("channel", ""))
                    st.write(f"**{item.get('title','')}**")
                    if st.button("?œì²­", key=f"watch_v2_{i}"):
                        st.session_state["selected_video"] = item
                        st.session_state["learning_cards"] = []
                        st.rerun()
        else:
            st.write("ì¶”ì²œ??ë¶€ì¡±í•´?? ? ì‹œ ???¤ì‹œ ?œë„??ì£¼ì„¸??")

    with col_right:
        st.markdown("#### ?™ìŠµ ?”ë©´")
        cards: List[Dict[str, Any]] = st.session_state.get("learning_cards", [])
        if cards:
            st.markdown("?œí˜„ ì¹´ë“œ (3)")
            for idx, c in enumerate(cards):
                st.markdown(f"**{idx+1}. {c['phrase']}**")
                cc1, cc2 = st.columns([2, 1])
                with cc1:
                    if c.get("imageUrl"):
                        st.image(c["imageUrl"], use_container_width=True)
                with cc2:
                    if st.button("ë°œìŒ ?£ê¸°", key=f"say_phrase_{idx}"):
                        try:
                            resp = asyncio.run(call_tool("say_word", {"word": c["phrase"], "voice": "en-US-AvaNeural"}))
                            b64 = resp.get("audioB64")
                            if b64:
                                st.audio(BytesIO(base64.b64decode(b64)), format="audio/mp3")
                            elif resp.get("audioUrl"):
                                st.audio(resp["audioUrl"])  # fallback
                        except Exception as e:
                            st.warning(f"ë°œìŒ ?ì„± ?¤íŒ¨: {e}")
            if st.button("?™ìŠµ ?„ë£Œ(ì§„í–‰ ?€??", key="save_progress_btn_v2"):
                try:
                    sel = st.session_state.get("selected_video") or {}
                    _ = asyncio.run(call_tool("update_progress", {
                        "childId": prof["childId"],
                        "videoId": sel.get("id", ""),
                        "learnedWords": [c["phrase"] for c in cards],
                        "quizScore": 90,
                        "durationSec": sel.get("durationSec", 300),
                    }))
                    vid_id = sel.get("id", ""); title = sel.get("title", "")
                    found = False
                    for it in st.session_state["watch_history"]:
                        if it.get("videoId") == vid_id:
                            it["learned"] = True
                            found = True
                            break
                    if not found:
                        st.session_state["watch_history"].append({"videoId": vid_id, "title": title, "watched": False, "learned": True})
                    st.success("?„ë£Œ! ?˜í–ˆ?´ìš” ?‰")
                except Exception as e:
                    st.error(f"?€???¤íŒ¨: {e}")
        else:
            st.write("?ìƒ???œì²­?˜ë©´ ?™ìŠµ ?œí˜„??ì¤€ë¹„ë©?ˆë‹¤.")


# New parent view v2 per spec
def parent_view_v2():
    prof = st.session_state["profile"]
    st.subheader("ë¶€ëª¨ìš© ì§„í–‰ ì²´í¬ ë°??¤ì •")
    col1, col2 = st.columns(2)
    with col1:
        st.markdown("#### ?™ìŠµ ?”ì•½ (7??")
        try:
            rep = asyncio.run(call_tool("parent_report", {"childId": prof["childId"], "period": "7d"}))
            st.write(rep.get("summaryText", ""))
            k = rep.get("kpis", {})
            st.metric("?œì²­ ë¶?, k.get("watchMin", 0))
            st.metric("?¸ì…˜", k.get("sessions", 0))
            st.metric("?™ìŠµ ?¨ì–´", k.get("wordsLearned", 0))
            st.metric("?ˆë²¨ ë³€??, k.get("levelChange", "+0"))
        except Exception as e:
            st.warning(f"?”ì•½ ì¡°íšŒ ?¤íŒ¨: {e}")

        hist = st.session_state.get("watch_history", [])
        watched_cnt = sum(1 for h in hist if h.get("watched"))
        learned_cnt = sum(1 for h in hist if h.get("learned"))
        st.markdown("#### ë¡œì»¬ ?”ì•½")
        st.metric("?œì²­ ?„ë£Œ ?ìƒ ??, watched_cnt)
        st.metric("?™ìŠµ ì¹´ë“œ ?„ë£Œ ??, learned_cnt)
        if hist:
            st.caption("ìµœê·¼ ?œë™")
            for h in hist[-5:][::-1]:
                st.write(f"- {h.get('title','(?œëª© ?†ìŒ)')} ?¶ì‹œì²?{'O' if h.get('watched') else 'X'} / ?™ìŠµ:{'O' if h.get('learned') else 'X'}")

    with col2:
        st.markdown("#### ?„ë¡œ???¤ì •")
        study_opts = ["ì²˜ìŒ?´ë‹¤", "1~3ê°œì›”", "3~6ê°œì›”", "6ê°œì›” ?´ìƒ"]
        cur_study = prof.get("study", "ì²˜ìŒ?´ë‹¤")
        idx = study_opts.index(cur_study) if cur_study in study_opts else 0
        with st.form("edit_profile_form_v2"):
            name = st.text_input("?´ë¦„", value=prof.get("name", ""))
            age = st.number_input("?˜ì´(ë§?", min_value=0, max_value=10, value=int(prof.get("age", 6)))
            region = st.text_input("ì§€??, value=prof.get("region", ""), placeholder="?? ?œìš¸ ë§ˆí¬êµ??©ì •??)
            study = st.selectbox("?ì–´ ê³µë? ê¸°ê°„", study_opts, index=idx)
            suggested = suggest_characters_by_age(int(age))
            current_chars = list(prof.get("characters", []))
            options = list(dict.fromkeys(suggested + current_chars))
            selected_chars = st.multiselect("ì¢‹ì•„?˜ëŠ” ìºë¦­??ì¶”ê?/?? œ)", options=options, default=current_chars)
            extra = st.text_input("ìºë¦­??ì¶”ê?(?¼í‘œë¡?êµ¬ë¶„)", placeholder="?? Pororo, Pikachu")
            interest = st.slider("?„ì´???ì–´ ?¥ë???, 1, 5, int(prof.get("interest", 4)))
            saved = st.form_submit_button("ë³€ê²½ì‚¬???€??)
            if saved:
                all_chars = list(selected_chars)
                if extra.strip():
                    all_chars.extend([c.strip() for c in extra.split(",") if c.strip()])
                new_cefr = derive_cefr(int(age), study)
                prof.update({
                    "name": name.strip(),
                    "age": int(age),
                    "region": region.strip(),
                    "study": study,
                    "characters": list(dict.fromkeys(all_chars)),
                    "cefr": new_cefr,
                    "interest": int(interest),
                })
                st.success(f"?€???„ë£Œ (CEFR: {new_cefr})")
                st.session_state["selected_video"] = None
                st.session_state["learning_cards"] = []
                st.rerun()

# Override setup view to avoid buttons inside form
def setup_view_v2():
    st.subheader("ì´ˆê¸° ?¤ì •")
    with st.form("setup_form_v2"):
        age = st.number_input("?˜ì´(ë§?", min_value=0, max_value=10, value=6)
        region = st.text_input("ì§€??, value="?œìš¸ ë§ˆí¬êµ??©ì •??, placeholder="?? ?œìš¸ ë§ˆí¬êµ??©ì •??)
        study = st.selectbox("?ì–´ ê³µë? ê¸°ê°„", ["ì²˜ìŒ?´ë‹¤", "1~3ê°œì›”", "3~6ê°œì›”", "6ê°œì›” ?´ìƒ"], index=0)
        suggested = suggest_characters_by_age(int(age))
        base_options = list(dict.fromkeys(suggested + [
            "Pororo", "Peppa Pig", "Bluey", "Pikachu", "Pinkfong",
            "Ben & Holly's Little Kingdom", "Thomas & Friends", "Octonauts",
            "Alphablocks", "Numberblocks", "Cocomelon", "Super Simple Songs",
            "Pocoyo", "Shaun the Sheep",
        ]))
        characters = st.multiselect("ì¢‹ì•„?˜ëŠ” ìºë¦­??, options=base_options, default=suggested)
        other = st.text_input("ê¸°í? ìºë¦­???¼í‘œë¡?êµ¬ë¶„)", placeholder="?? Pororo, Pikachu")
        saved = st.form_submit_button("?¤ì • ?€??)
        if saved:
            chars = list(characters)
            if other.strip():
                chars.extend([c.strip() for c in other.split(",") if c.strip()])
            cefr = derive_cefr(int(age), study)
            st.session_state["profile"] = {
                "age": int(age),
                "region": region.strip(),
                "study": study,
                "characters": chars or suggested,
                "cefr": cefr,
                "childId": ((st.session_state.get("profile") or {}).get("childId") or "local_child"),
                "interest": 4,
                "name": (st.session_state.get("profile") or {}).get("name", ""),
            }
            try:
                _ = asyncio.run(call_tool("save_profile", {
                    "childId": st.session_state["profile"]["childId"],
                    "name": st.session_state["profile"].get("name", ""),
                    "age": st.session_state["profile"]["age"],
                    "region": st.session_state["profile"]["region"],
                    "study": st.session_state["profile"]["study"],
                    "characters": st.session_state["profile"]["characters"],
                    "cefr": st.session_state["profile"]["cefr"],
                    "interest": st.session_state["profile"].get("interest", 4),
                }))
            except Exception:
                pass
            st.session_state["setup_saved"] = True
    # Confirm outside the form
    if st.session_state.get("setup_saved"):
        st.success("?¤ì •???€?¥í–ˆ?´ìš”. ?•ì¸???„ë¥´ë©???œ¼ë¡??´ë™?©ë‹ˆ??")
        if st.button("?•ì¸", key="confirm_setup_go_tabs"):
            st.session_state["setup_saved"] = False
            st.rerun()

# App flow
if not st.session_state["profile"]:
    setup_view_v2()
else:
    tabs = st.tabs(["?„ë™", "ë¶€ëª?])
    with tabs[0]:
        child_view_v2()
    with tabs[1]:
        parent_view_v2()
